<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Console</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="app-viewport" style="max-width: 800px; margin: 0 auto; padding: 40px 24px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 48px;">
            <div style="display: flex; align-items: center; gap: 16px;">
                <img src="https://imagizer.imageshack.com/img924/3628/vE9dmq.jpg" alt="Logo" style="height: 40px;">
                <div>
                    <h1 style="font-size: 18px; margin-bottom: 0;">Little Scholars Academy</h1>
                    <p style="font-size: 13px; color: var(--text-muted); font-weight: 500;">Parliament Elections 2026‚Äì27</p>
                </div>
            </div>
            <a href="{{ url_for('home') }}" style="color: var(--accent-blue); font-size: 15px; text-decoration: none; font-weight: 500;">Exit Console</a>
        </div>

        <div style="display: flex; flex-direction: column; gap: 32px;">
            <section class="panel" style="background: var(--glass-bg); backdrop-filter: blur(var(--glass-blur)); border: var(--glass-border); border-radius: var(--radius-l); padding: 24px;">
                <h2 style="font-size: 17px; font-weight: 600; margin-bottom: 20px;">Voter Management</h2>
                <div style="margin-bottom: 16px;">
                    <input type="text" id="voterSearch" placeholder="Search by ID, Roll No, or Section..." 
                           style="width: 100%; padding: 12px; background: rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.1); border-radius: 12px; font-size: 14px;"
                           onkeyup="doVoterSearch()">
                </div>
                <div id="voterSearchResults" style="max-height: 200px; overflow-y: auto; display: none; background: rgba(255,255,255,0.5); border-radius: 12px; border: 1px solid rgba(0,0,0,0.05); padding: 8px;">
                </div>
            </section>

            <section class="panel" style="background: var(--glass-bg); backdrop-filter: blur(var(--glass-blur)); border: var(--glass-border); border-radius: var(--radius-l); padding: 24px;">
                <h2 style="font-size: 17px; font-weight: 600; margin-bottom: 20px;">Election Posts</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 32px;">
                    <div>
                        <form action="{{ url_for('add_post') }}" method="POST" onsubmit="showLoading()">
                            <input type="text" name="post_name" class="system-field" placeholder="Post Name (e.g. House Captain)" required 
                                   style="width: 100%; padding: 12px; background: rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.1); border-radius: 12px; font-size: 15px; margin-bottom: 12px;">
                            <button type="submit" class="btn btn-main" style="width: 100%; padding: 12px; font-size: 14px;">Add Post</button>
                        </form>
                    </div>
                    <div style="max-height: 200px; overflow-y: auto;">
                        {% for post in posts %}
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--glass-border-inner);">
                            <span style="font-size: 14px; font-weight: 500;">{{ post }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </section>

            <section class="panel" style="background: var(--glass-bg); backdrop-filter: blur(var(--glass-blur)); border: var(--glass-border); border-radius: var(--radius-l); padding: 24px;">
                <h2 style="font-size: 17px; font-weight: 600; margin-bottom: 20px;">Candidate Provisioning</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 32px;">
                    <div>
                        <form action="{{ url_for('add_candidate') }}" method="POST" onsubmit="showLoading()">
                            <select name="post" class="system-field" required style="width: 100%; padding: 12px; background: rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.1); border-radius: 12px; font-size: 15px; margin-bottom: 12px;">
                                {% for post in posts %}
                                <option value="{{ post }}">{{ post }}</option>
                                {% endfor %}
                            </select>
                            <input type="text" name="name" class="system-field" placeholder="Full Name" required style="width: 100%; padding: 12px; background: rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.1); border-radius: 12px; font-size: 15px; margin-bottom: 12px;">
                            <select name="active" class="system-field" required style="width: 100%; padding: 12px; background: rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.1); border-radius: 12px; font-size: 15px; margin-bottom: 12px;">
                                <option value="10">MAIN MINISTER (Value 10)</option>
                                <option value="9">DY MINISTER (Value 9)</option>
                            </select>
                            <input type="url" name="image_url" class="system-field" placeholder="Image URL" style="width: 100%; padding: 12px; background: rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.1); border-radius: 12px; font-size: 15px; margin-bottom: 12px;">
                            <textarea name="motto" class="system-field" placeholder="Candidate Motto" style="width: 100%; padding: 12px; background: rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.1); border-radius: 12px; font-size: 15px; margin-bottom: 12px; min-height: 80px;"></textarea>
                            <button type="submit" class="btn btn-main" style="width: 100%; padding: 12px; font-size: 14px;">Add Candidate</button>
                        </form>
                        <div style="margin-top: 12px; display: flex; gap: 8px;">
                            <a href="{{ url_for('auto_populate_candidates') }}" class="btn btn-main" style="flex: 1; padding: 10px; font-size: 12px; background: rgba(0,0,0,0.05); color: #000; text-align: center; text-decoration: none;">Auto-Populate</a>
                        </div>
                    </div>
                    
                    <div style="max-height: 300px; overflow-y: auto;">
                        {% for post, names in candidates.items() %}
                        <div style="margin-bottom: 24px;">
                            <div style="font-size: 12px; font-weight: 700; color: var(--accent-blue); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px;">{{ post }}</div>
                            
                            <div style="font-size: 11px; font-weight: 700; color: #34c759; margin-bottom: 4px;">MAIN MINISTERS</div>
                            {% for candidate in names if candidate.active_raw == '10' %}
                            {% set cid = '0' %}
                            {% for raw_c in all_candidates_raw %}
                                {% if raw_c.Name == candidate.name and raw_c.Post == post %}
                                    {% set cid = raw_c.CandidateID %}
                                {% endif %}
                            {% endfor %}
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.5); border-radius: 12px; margin-bottom: 8px; border: 1px solid rgba(0,0,0,0.03);">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    {% if candidate.image %}
                                    <img src="{{ candidate.image }}" style="width: 40px; height: 40px; border-radius: 10px; object-fit: cover;">
                                    {% else %}
                                    <div class="avatar-core" style="width: 40px; height: 40px; font-size: 18px; border-radius: 10px;">üë§</div>
                                    {% endif %}
                                    <div>
                                        <div style="font-size: 15px; font-weight: 600;">{{ candidate.name }}</div>
                                        <div style="font-size: 11px; color: var(--accent-blue); font-weight: 700;">{{ candidate.role }}</div>
                                    </div>
                                </div>
                                <a href="{{ url_for('delete_candidate', candidate_id=cid) }}" 
                                   style="color: #ff3b30; font-size: 12px; font-weight: 600; text-decoration: none; padding: 6px 12px; border-radius: 8px; background: rgba(255,59,48,0.05);"
                                   onclick="return confirm('Delete this candidate?')">Delete</a>
                            </div>
                            {% endfor %}

                            <div style="font-size: 11px; font-weight: 700; color: #ff9500; margin-bottom: 4px; margin-top: 12px;">DY MINISTERS</div>
                            {% for candidate in names if candidate.active_raw == '9' %}
                            {% set cid = '0' %}
                            {% for raw_c in all_candidates_raw %}
                                {% if raw_c.Name == candidate.name and raw_c.Post == post %}
                                    {% set cid = raw_c.CandidateID %}
                                {% endif %}
                            {% endfor %}
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.5); border-radius: 12px; margin-bottom: 8px; border: 1px solid rgba(0,0,0,0.03);">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    {% if candidate.image %}
                                    <img src="{{ candidate.image }}" style="width: 40px; height: 40px; border-radius: 10px; object-fit: cover;">
                                    {% else %}
                                    <div class="avatar-core" style="width: 40px; height: 40px; font-size: 18px; border-radius: 10px;">üë§</div>
                                    {% endif %}
                                    <div>
                                        <div style="font-size: 15px; font-weight: 600;">{{ candidate.name }}</div>
                                        <div style="font-size: 11px; color: var(--accent-blue); font-weight: 700;">{{ candidate.role }}</div>
                                    </div>
                                </div>
                                <a href="{{ url_for('delete_candidate', candidate_id=cid) }}" 
                                   style="color: #ff3b30; font-size: 12px; font-weight: 600; text-decoration: none; padding: 6px 12px; border-radius: 8px; background: rgba(255,59,48,0.05);"
                                   onclick="return confirm('Delete this candidate?')">Delete</a>
                            </div>
                            {% endfor %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </section>

            <section class="panel" style="background: var(--glass-bg); backdrop-filter: blur(var(--glass-blur)); border: var(--glass-border); border-radius: var(--radius-l); padding: 24px;">
                <h2 style="font-size: 17px; font-weight: 600; margin-bottom: 20px;">Real-time Insights</h2>
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 24px;">
                    <div style="background: rgba(255,255,255,0.5); padding: 20px; border-radius: 16px; text-align: center;">
                        <div id="turnoutPercent" style="font-size: 48px; font-weight: 800; color: var(--accent-blue);">0%</div>
                        <div style="font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase;">Turnout Rate</div>
                    </div>
                    <div id="resultsTicker" style="background: rgba(0,0,0,0.02); padding: 15px; border-radius: 16px; font-size: 13px; max-height: 120px; overflow-y: auto;">
                        <div style="color: var(--text-muted);">Fetching live analytics...</div>
                    </div>
                </div>
            </section>

            <section class="panel" style="background: var(--glass-bg); backdrop-filter: blur(var(--glass-blur)); border: var(--glass-border); border-radius: var(--radius-l); padding: 24px;">
                <h2 style="font-size: 17px; font-weight: 600; margin-bottom: 20px;">System Status</h2>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;">
                    <div style="background: rgba(255,255,255,0.8); border: var(--glass-border); border-radius: 12px; padding: 16px;">
                        <div style="font-size: 20px; font-weight: 600;">{{ votes|length }}</div>
                        <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">Votes Cast</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.8); border: var(--glass-border); border-radius: 12px; padding: 16px;">
                        <div style="font-size: 20px; font-weight: 600;">{{ students|length }}</div>
                        <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">Students</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.8); border: var(--glass-border); border-radius: 12px; padding: 16px;">
                        <div style="font-size: 20px; font-weight: 600;">{{ teachers|length }}</div>
                        <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">Teachers</div>
                    </div>
                </div>
                
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <a href="{{ url_for('voter_gen') }}" class="btn btn-main" style="flex: 1; min-width: 140px; padding: 12px; font-size: 14px;">ID Gen</a>
                        <a href="{{ url_for('generate_teachers') }}" class="btn btn-main" style="flex: 1; min-width: 140px; padding: 12px; font-size: 14px; background: #5856d6;">Gen Teachers</a>
                        <a href="{{ url_for('generate_dummy_ids') }}" class="btn btn-main" style="flex: 1; min-width: 140px; padding: 12px; font-size: 14px; background: #ffcc00; color: #000;">Gen Dummy IDs</a>
                        <div style="display: flex; gap: 8px; width: 100%; margin-top: 12px;">
                        <a href="{{ url_for('print_students') }}" target="_blank" class="btn btn-main" style="flex: 1; padding: 10px; font-size: 13px; background: rgba(0,0,0,0.05); color: #000; text-align: center; text-decoration: none;">Print Students</a>
                        <a href="{{ url_for('print_teachers') }}" target="_blank" class="btn btn-main" style="flex: 1; padding: 10px; font-size: 13px; background: rgba(0,0,0,0.05); color: #000; text-align: center; text-decoration: none;">Print Teachers</a>
                        <a href="{{ url_for('print_dummies') }}" target="_blank" class="btn btn-main" style="flex: 1; padding: 10px; font-size: 13px; background: rgba(255,204,0,0.1); color: #000; text-align: center; text-decoration: none;">Print Dummies</a>
                        <a href="{{ url_for('print_candidates') }}" target="_blank" class="btn btn-main" style="flex: 1; padding: 10px; font-size: 13px; background: rgba(0,0,0,0.05); color: #000; text-align: center; text-decoration: none;">Print Candidates</a>
                        <a href="{{ url_for('print_all') }}" target="_blank" class="btn btn-main" style="flex: 1; padding: 10px; font-size: 13px; background: rgba(0,0,0,0.05); color: #000; text-align: center; text-decoration: none;">Full Summary</a>
                    </div>
                    <div style="display: flex; gap: 8px; width: 100%; margin-top: 12px;">
                        <a href="{{ url_for('toggle_pause') }}" id="pauseBtn" class="btn btn-main" style="flex: 1; padding: 12px; font-size: 14px; {% if election_paused %}background: #34c759;{% else %}background: #ff9500;{% endif %}">
                            {% if election_paused %}‚ñ∂ Unpause Election{% else %}‚è∏ Pause Election{% endif %}
                        </a>
                        <button class="btn btn-main" style="background: rgba(255, 59, 48, 0.1); color: #ff3b30; flex: 1; padding: 12px; font-size: 14px;" onclick="confirm('End election?')">End Election</button>
                    </div>
                    
                    {% if election_paused %}
                    <div id="pauseTimer" style="margin-top: 16px; padding: 16px; background: rgba(255, 149, 0, 0.1); border-radius: 12px; text-align: center;">
                        <div style="font-size: 12px; font-weight: 600; color: #ff9500; text-transform: uppercase; margin-bottom: 8px;">Election Paused For</div>
                        <div id="timerDisplay" style="font-size: 32px; font-weight: 700; color: #ff9500; font-family: monospace;">00:00:00</div>
                    </div>
                    {% endif %}
                </div>
            </section>
        </div>

        <div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); z-index: 10000; flex-direction: column; align-items: center; justify-content: center;">
            <div class="boot-core" style="margin-bottom: 24px;"></div>
            <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 8px;">Updating Database...</h2>
            <p style="color: var(--text-muted); font-size: 15px;">Please wait while we sync your changes.</p>
        </div>

        <script>
            function showLoading() {
                document.getElementById('loadingOverlay').style.display = 'flex';
            }
            
            {% if election_paused %}
            let pauseSeconds = 0;
            
            function updateTimer() {
                const timerEl = document.getElementById('timerDisplay');
                if (!timerEl) return;

                fetch('{{ url_for("pause_status") }}')
                    .then(r => r.json())
                    .then(data => {
                        if (data.paused) {
                            pauseSeconds = data.elapsed_seconds;
                            const hrs = Math.floor(pauseSeconds / 3600);
                            const mins = Math.floor((pauseSeconds % 3600) / 60);
                            const secs = pauseSeconds % 60;
                            timerEl.textContent = 
                                String(hrs).padStart(2, '0') + ':' + 
                                String(mins).padStart(2, '0') + ':' + 
                                String(secs).padStart(2, '0');
                        } else {
                            // If it resumed, we should probably reload or hide the timer
                            location.reload();
                        }
                    })
                    .catch(() => {});
            }
            
            updateTimer();
            setInterval(updateTimer, 1000);
            {% endif %}

            function updateAnalytics() {
                fetch('{{ url_for("get_analytics") }}')
                    .then(r => r.json())
                    .then(data => {
                        if (data.total_eligible > 0) {
                            const percent = Math.round((data.turnout / data.total_eligible) * 100);
                            document.getElementById('turnoutPercent').textContent = percent + '%';
                        }
                        
                        const ticker = document.getElementById('resultsTicker');
                        let html = '';
                        for (const [post, results] of Object.entries(data.results)) {
                            html += `<div style="margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid rgba(0,0,0,0.03);">`;
                            html += `<div style="font-weight: 700; color: var(--accent-blue); margin-bottom: 4px;">${post}</div>`;
                            const sorted = Object.entries(results).sort((a,b) => b[1] - a[1]);
                            if (sorted.length > 0) {
                                sorted.slice(0, 3).forEach(([name, count], i) => {
                                    const opacity = 1 - (i * 0.2);
                                    html += `<div style="display: flex; justify-content: space-between; opacity: ${opacity};">
                                        <span>${i+1}. ${name}</span>
                                        <b>${count}</b>
                                    </div>`;
                                });
                            } else {
                                html += '<div style="color: var(--text-muted);">No votes yet</div>';
                            }
                            html += `</div>`;
                        }
                        ticker.innerHTML = html;
                    })
                    .catch(console.error);
            }

            let searchTimeout;
            function doVoterSearch() {
                clearTimeout(searchTimeout);
                const q = document.getElementById('voterSearch').value;
                if (q.length < 2) {
                    document.getElementById('voterSearchResults').style.display = 'none';
                    return;
                }
                
                searchTimeout = setTimeout(() => {
                    fetch(`/admin/voters/search?q=${q}`)
                        .then(r => r.json())
                        .then(data => {
                            const container = document.getElementById('voterSearchResults');
                            container.style.display = 'block';
                            if (data.length === 0) {
                                container.innerHTML = '<div style="padding: 10px; font-size: 13px; color: var(--text-muted);">No matching voters found.</div>';
                                return;
                            }
                            container.innerHTML = data.map(v => {
                                const rowStyle = v.Used === 'YES' ? 'background: rgba(255, 59, 48, 0.05);' : '';
                                return `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid rgba(0,0,0,0.05); ${rowStyle} border-radius: 8px; margin-bottom: 4px;">
                                    <div style="font-size: 13px;">
                                        <b style="font-family: monospace; font-size: 15px;">${v.VotingID}</b> 
                                        <span style="color: var(--text-muted); margin-left: 8px;">Cl ${v.Class} (${v.Section}) Roll ${v.RollNo}</span>
                                        <span style="margin-left: 12px; font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 6px; background: ${v.Used === 'YES' ? '#ff3b30' : '#34c759'}; color: white;">
                                            ${v.Used === 'YES' ? 'BALLOT USED' : 'ELIGIBLE'}
                                        </span>
                                    </div>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        ${v.Used === 'YES' ? `
                                            <div style="font-size: 11px; color: #ff3b30; font-weight: 700; background: white; padding: 4px 8px; border-radius: 6px; border: 1px solid rgba(255,59,48,0.2);">
                                                Verified
                                            </div>
                                            <button onclick="resetVoter('${v.VotingID}')" style="font-size: 11px; padding: 6px 12px; background: #000; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Reset</button>
                                        ` : ''}
                                    </div>
                                </div>
                            `; }).join('');
                        });
                }, 300);
            }

            function resetVoter(voterId) {
                if (!confirm(`Allow ID ${voterId} to vote again?`)) return;
                fetch('/admin/voters/reset', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({voter_id: voterId})
                })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        alert('Voter access reset successfully.');
                        doVoterSearch();
                        updateAnalytics();
                    }
                });
            }

            updateAnalytics();
            setInterval(updateAnalytics, 10000);
        </script>

        <footer>
            <p>üå± Paperless Election Initiative</p>
        </footer>
    </div>
</body>
</html>
